<!DOCTYPE html>
<html>
<head>
  <title>Management Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafd; }
    .dashboard { max-width: 1100px; margin: 2em auto; background: #fff; border-radius: 8px; padding: 2em; }
    h2 { color: #2c3e50; }
    .nav { display: flex; gap: 1em; margin-bottom: 2em; flex-wrap: wrap; }
    .nav button { padding: 0.7em 1.5em; background: #3498db; color: #fff; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .nav button.active { background: #2980b9; }
    .nav button:last-child { background: #e74c3c; }
    .section { margin-bottom: 2em; }
    .form-group { margin: 1em 0; }
    .form-group label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 0.7em; border: 1px solid #ddd; border-radius: 4px; }
    .btn { padding: 0.7em 1.5em; background: #27ae60; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .btn-danger { background: #e74c3c; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 0.7em; border: 1px solid #ddd; text-align: left; }
    th { background: #f8f9fa; }
    .error { color: red; margin-top: 1em; }
    .success { color: green; margin-top: 1em; }
  </style>
</head>
<body>
  <script>
    // Protect the page: Only management can access
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login.html';
    function parseJwt(token) {
      try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return {}; }
    }
    const user = parseJwt(token);
    if (user.role !== 'management') window.location.href = '/login.html';
  </script>
  <div class="dashboard">
    <h2>Management Dashboard</h2>
    <!-- Department Login Creation Form -->
    <div style="background:#f6f9ff; padding:1em 2em; border-radius:8px; margin-bottom:2em;">
      <h3>Create Department Login</h3>
      <form id="deptLoginForm" style="display:flex; gap:1em; align-items:center; flex-wrap:wrap;">
        <label>Username <input type="text" id="deptLoginUsername" required></label>
        <label>Password <input type="password" id="deptLoginPassword" required></label>
        <label>Department
          <select id="deptLoginDept" required style="min-width:150px"></select>
        </label>
        <button type="submit" class="btn">Create Login</button>
        <span id="deptLoginMsg"></span>
      </form>
    </div>
    <!-- Navigation -->
    <div class="nav">
      <button onclick="showSection('patients')" id="btn-patients">Patients</button>
      <button onclick="showSection('doctors')" id="btn-doctors">Doctors</button>
      <button onclick="showSection('departments')" id="btn-departments">Departments</button>
      <button onclick="showSection('visits')" id="btn-visits">Visits/Appointments</button>
      <button onclick="showSection('logs')" id="btn-logs">Audit Logs</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="mainContent" class="section"></div>
  </div>
  <script>
    // Department Login Creation Logic
    async function loadDeptOptions() {
      const res = await fetch('/departments', { headers: { 'Authorization': 'Bearer ' + token } });
      const depts = await res.json();
      const sel = document.getElementById('deptLoginDept');
      sel.innerHTML = '<option value="">Select department</option>' +
        depts.map(d => `<option value="${d.department_id}">${d.name}</option>`).join('');
    }
    loadDeptOptions();

    document.getElementById('deptLoginForm').onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById('deptLoginUsername').value.trim();
      const password = document.getElementById('deptLoginPassword').value;
      const department_id = document.getElementById('deptLoginDept').value;
      const msg = document.getElementById('deptLoginMsg');
      msg.textContent = '';
      if (!username || !password || !department_id) {
        msg.textContent = 'All fields required.';
        msg.style.color = 'red';
        return;
      }
      try {
        const res = await fetch('/users/department', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ username, password, department_id })
        });
        const data = await res.json();
        if (res.ok) {
          msg.textContent = 'Department login created!';
          msg.style.color = 'green';
          document.getElementById('deptLoginForm').reset();
        } else {
          msg.textContent = data.error || 'Error creating login';
          msg.style.color = 'red';
        }
      } catch (err) {
        msg.textContent = 'Server error';
        msg.style.color = 'red';
      }
    };

    // --- Navigation and Section Logic ---
    let currentSection = '';
    function showSection(section) {
      currentSection = section;
      document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${section}`).classList.add('active');
      const content = document.getElementById('mainContent');
      content.innerHTML = '<b>Loading...</b>';
      if (section === 'patients') showPatientsSection();
      else if (section === 'doctors') showDoctorsSection();
      else if (section === 'departments') showDepartmentsSection();
      else if (section === 'visits') showVisitsSection();
      else if (section === 'logs') showLogsSection();
      else content.innerHTML = `<b>${section} section coming soon...</b>`;
    }
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    // --- Patients Section ---
    function showPatientsSection() {
      document.getElementById('mainContent').innerHTML = `
        <h3>Patient Management</h3>
        <form id="patientForm">
          <div class="form-group"><label>First Name*</label><input type="text" id="firstName" required></div>
          <div class="form-group"><label>Last Name*</label><input type="text" id="lastName" required></div>
          <div class="form-group"><label>Date of Birth*</label><input type="date" id="dob" required></div>
          <div class="form-group"><label>Sex*</label>
            <select id="sex" required>
              <option value="">Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Phone</label><input type="text" id="phone" placeholder="+91XXXXXXXXXX"></div>
          <div class="form-group"><label>Aadhaar Number</label><input type="text" id="aadhaar" maxlength="12"></div>
          <div class="form-group"><label>Address*</label><input type="text" id="address" required></div>
          <div class="form-group"><label>Allergies</label><input type="text" id="allergies"></div>
          <div class="form-group"><label>Emergency Contact</label><input type="text" id="emergencyContact"></div>
          <button type="submit" class="btn">Add Patient</button>
          <div id="patientFormMsg"></div>
        </form>
        <h4>All Patients</h4>
        <table id="patientsTable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>DOB</th><th>Sex</th><th>Phone</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      loadPatients();
      document.getElementById('patientForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = {
          first_name: document.getElementById('firstName').value.trim(),
          last_name: document.getElementById('lastName').value.trim(),
          dob: document.getElementById('dob').value,
          sex: document.getElementById('sex').value,
          phone: document.getElementById('phone').value.trim(),
          aadhaar_number: document.getElementById('aadhaar').value.trim(),
          address: document.getElementById('address').value.trim(),
          allergies: document.getElementById('allergies').value.trim(),
          emergency_contact: document.getElementById('emergencyContact').value.trim()
        };
        try {
          const res = await fetch('/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(formData)
          });
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to add patient');
          document.getElementById('patientFormMsg').innerHTML = '<div class="success">Patient added successfully!</div>';
          document.getElementById('patientForm').reset();
          loadPatients();
        } catch (err) {
          document.getElementById('patientFormMsg').innerHTML = `<div class="error">Error: ${err.message}</div>`;
        }
      };
    }
    async function loadPatients() {
      try {
        const res = await fetch('/patients', { headers: { 'Authorization': 'Bearer ' + token } });
        const patients = await res.json();
        const tbody = document.querySelector('#patientsTable tbody');
        tbody.innerHTML = patients.map(p => `
          <tr>
            <td>${p.patient_id}</td>
            <td>${p.first_name} ${p.last_name}</td>
            <td>${new Date(p.dob).toLocaleDateString()}</td>
            <td>${p.sex}</td>
            <td>${p.phone || '-'}</td>
            <td>
              <button class="btn btn-danger" onclick="deletePatient('${p.patient_id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading patients:', err);
      }
    }
    window.deletePatient = async function(patient_id) {
      if (!confirm('Are you sure you want to delete this patient?')) return;
      try {
        const res = await fetch(`/patients/${patient_id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) loadPatients();
      } catch (err) { alert('Error deleting patient'); }
    };

    // --- Doctors Section ---
    function showDoctorsSection() {
      document.getElementById('mainContent').innerHTML = `
        <h3>Doctor Management</h3>
        <form id="doctorForm">
          <div class="form-group"><label>Name*</label><input type="text" id="docName" required></div>
          <div class="form-group"><label>MCI Number*</label><input type="text" id="docMci" required></div>
          <div class="form-group"><label>Specialization</label><input type="text" id="docSpec"></div>
          <div class="form-group"><label>Department*</label>
            <select id="docDept" required></select>
          </div>
          <button type="submit" class="btn">Add Doctor</button>
          <div id="doctorFormMsg"></div>
        </form>
        <h4>All Doctors</h4>
        <table id="doctorsTable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>MCI</th><th>Specialization</th><th>Department</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <h4>Create Doctor User Account</h4>
        <form id="doctorUserForm">
          <div class="form-group"><label>Username*</label><input type="text" id="doctorUserUsername" required></div>
          <div class="form-group"><label>Password*</label><input type="password" id="doctorUserPassword" required></div>
          <div class="form-group"><label>Doctor*</label>
            <select id="doctorUserDoctor" required></select>
          </div>
          <button type="submit" class="btn">Create Doctor User</button>
          <div id="doctorUserFormMsg"></div>
        </form>
      `;
      loadDepartmentsForDoctors();
      loadDoctors();
      loadDoctorsForUser();
      document.getElementById('doctorForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = {
          name: document.getElementById('docName').value.trim(),
          mci_number: document.getElementById('docMci').value.trim(),
          specialization: document.getElementById('docSpec').value.trim(),
          department_id: document.getElementById('docDept').value
        };
        try {
          const res = await fetch('/doctors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(formData)
          });
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to add doctor');
          document.getElementById('doctorFormMsg').innerHTML = '<div class="success">Doctor added successfully!</div>';
          document.getElementById('doctorForm').reset();
          loadDoctors();
          loadDoctorsForUser();
        } catch (err) {
          document.getElementById('doctorFormMsg').innerHTML = `<div class="error">Error: ${err.message}</div>`;
        }
      };
      document.getElementById('doctorUserForm').onsubmit = async function(e) {
        e.preventDefault();
        const username = document.getElementById('doctorUserUsername').value.trim();
        const password = document.getElementById('doctorUserPassword').value;
        const doctor_id = document.getElementById('doctorUserDoctor').value;
        try {
          const res = await fetch('/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ username, password, role: 'doctor', doctor_id })
          });
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to create user');
          document.getElementById('doctorUserFormMsg').innerHTML = '<div class="success">Doctor user created!</div>';
          document.getElementById('doctorUserForm').reset();
        } catch (err) {
          document.getElementById('doctorUserFormMsg').innerHTML = `<div class="error">Error: ${err.message}</div>`;
        }
      };
    }
    async function loadDepartmentsForDoctors() {
      const res = await fetch('/departments', { headers: { 'Authorization': 'Bearer ' + token } });
      const depts = await res.json();
      const sel = document.getElementById('docDept');
      sel.innerHTML = '<option value="">Select</option>' + depts.map(d => `<option value="${d.department_id}">${d.name}</option>`).join('');
    }
    async function loadDoctors() {
      const res = await fetch('/doctors', { headers: { 'Authorization': 'Bearer ' + token } });
      const doctors = await res.json();
      const tbody = document.querySelector('#doctorsTable tbody');
      tbody.innerHTML = doctors.map(d => `
        <tr>
          <td>${d.doctor_id}</td>
          <td>${d.name}</td>
          <td>${d.mci_number}</td>
          <td>${d.specialization || '-'}</td>
          <td>${d.department_name || '-'}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteDoctor('${d.doctor_id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }
    async function loadDoctorsForUser() {
      const res = await fetch('/doctors', { headers: { 'Authorization': 'Bearer ' + token } });
      const doctors = await res.json();
      const sel = document.getElementById('doctorUserDoctor');
      sel.innerHTML = '<option value="">Select</option>' + doctors.map(d => `<option value="${d.doctor_id}">${d.name}</option>`).join('');
    }
    window.deleteDoctor = async function(doctor_id) {
      if (!confirm('Are you sure you want to delete this doctor?')) return;
      try {
        const res = await fetch(`/doctors/${doctor_id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) loadDoctors();
      } catch (err) { alert('Error deleting doctor'); }
    };

    // --- Departments Section ---
    function showDepartmentsSection() {
      document.getElementById('mainContent').innerHTML = `
        <h3>Department Management</h3>
        <form id="departmentForm">
          <div class="form-group"><label>Name*</label><input type="text" id="deptName" required></div>
          <button type="submit" class="btn">Add Department</button>
          <div id="departmentFormMsg"></div>
        </form>
        <h4>All Departments</h4>
        <table id="departmentsTable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      loadDepartments();
      document.getElementById('departmentForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('deptName').value.trim();
        try {
          const res = await fetch('/departments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ name })
          });
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to add department');
          document.getElementById('departmentFormMsg').innerHTML = '<div class="success">Department added!</div>';
          document.getElementById('departmentForm').reset();
          loadDepartments();
          loadDeptOptions();
        } catch (err) {
          document.getElementById('departmentFormMsg').innerHTML = `<div class="error">Error: ${err.message}</div>`;
        }
      };
    }
    async function loadDepartments() {
      const res = await fetch('/departments', { headers: { 'Authorization': 'Bearer ' + token } });
      const depts = await res.json();
      const tbody = document.querySelector('#departmentsTable tbody');
      tbody.innerHTML = depts.map(d => `
        <tr>
          <td>${d.department_id}</td>
          <td>${d.name}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteDepartment('${d.department_id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }
    window.deleteDepartment = async function(department_id) {
      if (!confirm('Are you sure you want to delete this department?')) return;
      try {
        const res = await fetch(`/departments/${department_id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) { loadDepartments(); loadDeptOptions(); }
      } catch (err) { alert('Error deleting department'); }
    };

    // --- Visits Section ---
    function showVisitsSection() {
      document.getElementById('mainContent').innerHTML = `
        <h3>Visits/Appointments</h3>
        <table id="visitsTable">
          <thead>
            <tr>
              <th>ID</th><th>Patient</th><th>Doctor</th><th>Department</th><th>Reason</th><th>Status</th><th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      loadVisits();
    }
    async function loadVisits() {
      const res = await fetch('/visits', { headers: { 'Authorization': 'Bearer ' + token } });
      const visits = await res.json();
      const tbody = document.querySelector('#visitsTable tbody');
      tbody.innerHTML = visits.map(v => `
        <tr>
          <td>${v.visit_id}</td>
          <td>${v.patient_name || v.patient_id}</td>
          <td>${v.doctor_name || v.doctor_id}</td>
          <td>${v.department_name || v.department_id}</td>
          <td>${v.reason || '-'}</td>
          <td>${v.status}</td>
          <td>${new Date(v.created_at).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    // --- Audit Logs Section ---
    function showLogsSection() {
      document.getElementById('mainContent').innerHTML = `
        <h3>Audit Logs</h3>
        <table id="logsTable">
          <thead>
            <tr>
              <th>ID</th><th>User</th><th>Action</th><th>Entity</th><th>Details</th><th>Timestamp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      loadLogs();
    }
    async function loadLogs() {
      const res = await fetch('/audit_logs', { headers: { 'Authorization': 'Bearer ' + token } });
      const logs = await res.json();
      const tbody = document.querySelector('#logsTable tbody');
      tbody.innerHTML = logs.map(l => `
        <tr>
          <td>${l.log_id}</td>
          <td>${l.user_id}</td>
          <td>${l.action}</td>
          <td>${l.entity_type || '-'}</td>
          <td>${l.details || '-'}</td>
          <td>${new Date(l.timestamp).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    // Default section
    showSection('patients');
  </script>
</body>
</html>